```{r}
# Load the main data table and select necessary columns
main_table <- read_excel(here::here("DATA/MASTER.xlsx")) %>% as_tibble()
main_table <- main_table %>%
  dplyr::select(locality, PAR_sp, CAT_sp, PLANT_sp)

# Load the distance matrix
Distance <- read.csv2(here::here("DATA", "Distance.csv"), row.names = 1) # Distance matrix of localities

# Prepare the distance matrix for visualization
Distance_fig <- read.csv2(here::here("DATA/Distance.csv"))
distance_2 <- reshape::melt(Distance_fig)   # Transform the matrix into a long format
distance_plot <- dplyr::rename(distance_2, Locality_A = X, Locality_B = variable, distance = value)  # Rename columns

# Prepare contingency tables for each locality
# Filter data for "Elem" locality and create a contingency table
Elem_full_PC <- main_table %>%
  filter(locality == "Elem") %>%
  select(CAT_sp, PAR_sp)
Elem3_full_PC <- as.matrix(table(Elem_full_PC$CAT_sp, Elem_full_PC$PAR_sp)) 

# Repeat the same process for other localities
Morox_full_PC <- main_table %>%
  filter(locality == "Morox") %>%
  select(CAT_sp, PAR_sp)
Morox3_full_PC <- as.matrix(table(Morox_full_PC$CAT_sp, Morox_full_PC$PAR_sp))

Niksek_full_PC <- main_table %>%
  filter(locality == "Niksek") %>%
  select(CAT_sp, PAR_sp)
Niksek3_full_PC <- as.matrix(table(Niksek_full_PC$CAT_sp, Niksek_full_PC$PAR_sp))

Ohu1_full_PC <- main_table %>%
  filter(locality == "Ohu1") %>%
  select(CAT_sp, PAR_sp)
Ohu13_full_PC <- as.matrix(table(Ohu1_full_PC$CAT_sp, Ohu1_full_PC$PAR_sp))

Ohu2_full_PC <- main_table %>%
  filter(locality == "Ohu2") %>%
  select(CAT_sp, PAR_sp)
Ohu2_3_full_PC <- as.matrix(table(Ohu2_full_PC$CAT_sp, Ohu2_full_PC$PAR_sp))

Utai_full_PC <- main_table %>%
  filter(locality == "Utai") %>%
  select(CAT_sp, PAR_sp)
Utai3_full_PC <- as.matrix(table(Utai_full_PC$CAT_sp, Utai_full_PC$PAR_sp))

Wamangu_full_PC <- main_table %>%
  filter(locality == "Wamangu") %>%
  select(CAT_sp, PAR_sp)
Wamangu3_full_PC <- as.matrix(table(Wamangu_full_PC$CAT_sp, Wamangu_full_PC$PAR_sp))

Wanang_full_PC <- main_table %>%
  filter(locality == "Wanang") %>%
  select(CAT_sp, PAR_sp)
Wanang3_full_PC <- as.matrix(table(Wanang_full_PC$CAT_sp, Wanang_full_PC$PAR_sp))

Yapsiei_full_PC <- main_table %>%
  filter(locality == "Yapsiei") %>%
  select(CAT_sp, PAR_sp)
Yapsiei3_full_PC <- as.matrix(table(Yapsiei_full_PC$CAT_sp, Yapsiei_full_PC$PAR_sp))

# Analyses of interactions

FW_full_PC_results<-betalinkr_multi(webs2array(Elem3_full_PC,Morox3_full_PC,Niksek3_full_PC,Ohu13_full_PC,Ohu2_3_full_PC,Utai3_full_PC, Wamangu3_full_PC, Wanang3_full_PC, Yapsiei3_full_PC), partitioning="commondenom", partition.st=TRUE)
bFW_full_PC_results<-FW_full_PC_results %>% add_column(dataset = "whole_CAT_PAR")

FW_ST_full_PC<-pivot_to_numeric_matrix(FW_full_PC_results, i, j, ST)
FW_OS_full_PC<-pivot_to_numeric_matrix(FW_full_PC_results, i, j, OS)
FW_WN_full_PC<-pivot_to_numeric_matrix(FW_full_PC_results, i, j, WN)
FW_ST_full_PC<-pivot_to_numeric_matrix(FW_full_PC_results, i, j, ST)
FW_ST.l_full_PC<-pivot_to_numeric_matrix(FW_full_PC_results, i, j, ST.l)
FW_ST.h_full_PC<-pivot_to_numeric_matrix(FW_full_PC_results, i, j, ST.h)
FW_ST.lh_full_PC<-pivot_to_numeric_matrix(FW_full_PC_results, i, j, ST.lh)


#FW - FULL - PC OS - full dataset

# OS
xmnames<-unique(c(FW_full_PC_results$i,FW_full_PC_results$j))
xm <- matrix( rep(0,81),nrow=9,ncol=9)
colnames(xm) <- xmnames; rownames(xm) <- xmnames
xm[lower.tri(xm,diag=F)] <-FW_full_PC_results$OS
xm[upper.tri(xm,diag=F)] <-FW_full_PC_results$OS
FW_OS_full_PC<-xm
mantel(FW_OS_full_PC, Distance , method="spear")

# priprava na grafiku

rownames(FW_OS_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")
colnames(FW_OS_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")

FW_OS_full_PC <- as.matrix(FW_OS_full_PC)
FW_OS_full_PC_2 <- melt(FW_OS_full_PC)
FW_OS_full_PC_2 <- dplyr::rename(FW_OS_full_PC_2, Locality_A = Var1, Locality_B = Var2, hodnota = value) %>%
  add_column(guild = "OS")
FW_OS_full_PC_2<- merge(FW_OS_full_PC_2, distance_plot, by=c("Locality_A", "Locality_B")) %>%
  filter (hodnota > 0)
FW_OS_full_PC_2$Dataset <-"PAR-CAT"
FW_OS_full_PC_2$Type <-"Full"

#FW - FULL - PC WN - full dataset

# WN
xmnames<-unique(c(FW_full_PC_results$i,FW_full_PC_results$j))
xm <- matrix( rep(0,81),nrow=9,ncol=9)
colnames(xm) <- xmnames; rownames(xm) <- xmnames
xm[lower.tri(xm,diag=F)] <-FW_full_PC_results$WN
xm[upper.tri(xm,diag=F)] <-FW_full_PC_results$WN
FW_WN_full_PC<-xm
mantel(FW_WN_full_PC, Distance , method="spear")

# priprava na grafiku

rownames(FW_WN_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")
colnames(FW_WN_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")

FW_WN_full_PC <- as.matrix(FW_WN_full_PC)
FW_WN_full_PC_2 <- melt(FW_WN_full_PC)
FW_WN_full_PC_2 <- dplyr::rename(FW_WN_full_PC_2, Locality_A = Var1, Locality_B = Var2, hodnota = value) %>%
  add_column(guild = "WN")
FW_WN_full_PC_2<- merge(FW_WN_full_PC_2, distance_plot, by=c("Locality_A", "Locality_B")) %>%
  filter (hodnota > 0)



#FW - FULL - PC ST- full dataset

# ST
xmnames<-unique(c(FW_full_PC_results$i,FW_full_PC_results$j))
xm <- matrix( rep(0,81),nrow=9,ncol=9)
colnames(xm) <- xmnames; rownames(xm) <- xmnames
xm[lower.tri(xm,diag=F)] <-FW_full_PC_results$ST
xm[upper.tri(xm,diag=F)] <-FW_full_PC_results$ST
FW_ST_full_PC<-xm
mantel(FW_ST_full_PC, Distance , method="spear")

# priprava na grafiku

rownames(FW_ST_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")
colnames(FW_ST_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")

FW_ST_full_PC <- as.matrix(FW_ST_full_PC)
FW_ST_full_PC_2 <- melt(FW_ST_full_PC)
FW_ST_full_PC_2 <- dplyr::rename(FW_ST_full_PC_2, Locality_A = Var1, Locality_B = Var2, hodnota = value) %>%
  add_column(guild = "ST")
FW_ST_full_PC_2<- merge(FW_ST_full_PC_2, distance_plot, by=c("Locality_A", "Locality_B")) %>%
  filter (hodnota > 0)



#FW - FULL - PC ST.l- full dataset

#ST.l
xmnames<-unique(c(FW_full_PC_results$i,FW_full_PC_results$j))
xm <- matrix( rep(0,81),nrow=9,ncol=9)
colnames(xm) <- xmnames; rownames(xm) <- xmnames
xm[lower.tri(xm,diag=F)] <-FW_full_PC_results$ST.l
xm[upper.tri(xm,diag=F)] <-FW_full_PC_results$ST.l
FW_ST.l_full_PC<-xm
mantel(FW_ST.l_full_PC, Distance , method="spear")

# priprava na grafiku

rownames(FW_ST.l_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")
colnames(FW_ST.l_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")

FW_ST.l_full_PC <- as.matrix(FW_ST.l_full_PC)
FW_ST.l_full_PC_2 <- melt(FW_ST.l_full_PC)
FW_ST.l_full_PC_2 <- dplyr::rename(FW_ST.l_full_PC_2, Locality_A = Var1, Locality_B = Var2, hodnota = value) %>%
  add_column(guild = "ST.l")
FW_ST.l_full_PC_2<- merge(FW_ST.l_full_PC_2, distance_plot, by=c("Locality_A", "Locality_B")) %>%
  filter (hodnota > 0)


#FW - FULL - PC ST-h - full dataset


xmnames<-unique(c(FW_full_PC_results$i,FW_full_PC_results$j))
xm <- matrix( rep(0,81),nrow=9,ncol=9)
colnames(xm) <- xmnames; rownames(xm) <- xmnames
xm[lower.tri(xm,diag=F)] <-FW_full_PC_results$ST.h
xm[upper.tri(xm,diag=F)] <-FW_full_PC_results$ST.h
FW_ST.h_full_PC<-xm
mantel(FW_ST.h_full_PC, Distance , method="spear")

# priprava na grafiku

rownames(FW_ST.h_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")
colnames(FW_ST.h_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang","Yapsiei")

FW_ST.h_full_PC <- as.matrix(FW_ST.h_full_PC)
FW_ST.h_full_PC_2 <- melt(FW_ST.h_full_PC)
FW_ST.h_full_PC_2 <- dplyr::rename(FW_ST.h_full_PC_2, Locality_A = Var1, Locality_B = Var2, hodnota = value) %>%
  add_column(guild = "ST.h")
FW_ST.h_full_PC_2<- merge(FW_ST.h_full_PC_2, distance_plot, by=c("Locality_A", "Locality_B")) %>%
  filter (hodnota > 0)



#FW - FULL - PC ST.lh - full dataset

#ST.lh

xmnames<-unique(c(FW_full_PC_results$i,FW_full_PC_results$j))
xm <- matrix( rep(0,81),nrow=9,ncol=9)
colnames(xm) <- xmnames; rownames(xm) <- xmnames
xm[lower.tri(xm,diag=F)] <-FW_full_PC_results$ST.lh
xm[upper.tri(xm,diag=F)] <-FW_full_PC_results$ST.lh
FW_ST.lh_full_PC<-xm
mantel(FW_ST.lh_full_PC, Distance , method="spear")

# Prepare the data for visualization

# Assign row and column names to the FW_ST.lh_full_PC matrix
rownames(FW_ST.lh_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang", "Yapsiei")
colnames(FW_ST.lh_full_PC) <- c("Elem", "Morox", "Niksek", "Ohu1", "Ohu2", "Utai", "Wamangu", "Wanang", "Yapsiei")

# Convert the dataframe into a matrix
FW_ST.lh_full_PC <- as.matrix(FW_ST.lh_full_PC)

# Reshape the matrix into a long format
FW_ST.lh_full_PC_2 <- melt(FW_ST.lh_full_PC)

# Rename columns for clarity and add a "guild" column
FW_ST.lh_full_PC_2 <- dplyr::rename(FW_ST.lh_full_PC_2, Locality_A = Var1, Locality_B = Var2, hodnota = value) %>%
  add_column(guild = "ST.lh")

# Merge with the distance_plot dataset and filter rows with hodnota > 0
FW_ST.lh_full_PC_2 <- merge(FW_ST.lh_full_PC_2, distance_plot, by = c("Locality_A", "Locality_B")) %>%
  filter(hodnota > 0)

# Mantel tests for correlations between FW matrices and the distance matrix

# Perform Mantel tests using Spearman's method for various datasets
mantel_FW_OS_full_PC <- mantel(FW_OS_full_PC, Distance, method = "spear")
mantel_FW_ST_full_PC <- mantel(FW_ST_full_PC, Distance, method = "spear")
mantel_FW_WN_full_PC <- mantel(FW_WN_full_PC, Distance, method = "spear")
mantel_FW_ST_l_full_PC <- mantel(FW_ST.l_full_PC, Distance, method = "spear")
mantel_FW_ST_h_full_PC <- mantel(FW_ST.h_full_PC, Distance, method = "spear")
mantel_FW_ST_lh_full_PC <- mantel(FW_ST.lh_full_PC, Distance, method = "spear")

# Summarize the datasets

# Calculate mean and standard deviation for each dataset
summary_FW_OS_full_PC <- summarise(FW_OS_full_PC_2, mean_OS = mean(hodnota), sd_OS = sd(hodnota))
summary_FW_WN_full_PC <- summarise(FW_WN_full_PC_2, mean_WN = mean(hodnota), sd_WN = sd(hodnota))
summary_FW_ST_full_PC <- summarise(FW_ST_full_PC_2, mean_ST = mean(hodnota), sd_ST = sd(hodnota))
summary_FW_ST_l_full_PC <- summarise(FW_ST.l_full_PC_2, mean_ST_l = mean(hodnota), sd_ST_l = sd(hodnota))
summary_FW_ST_h_full_PC <- summarise(FW_ST.h_full_PC_2, mean_ST_h = mean(hodnota), sd_ST_h = sd(hodnota))
summary_FW_ST_lh_full_PC <- summarise(FW_ST.lh_full_PC_2, mean_ST_lh = mean(hodnota), sd_ST_lh = sd(hodnota))

# Combine Mantel test results into a dataframe
mantel_results <- data.frame(
  Group = c("FW_OS_full_PC", "FW_ST_full_PC", "FW_WN_full_PC", 
           "FW_ST.l_full_PC", "FW_ST.h_full_PC", "FW_ST.lh_full_PC"),
  Statistic = c(mantel_FW_OS_full_PC$statistic, mantel_FW_ST_full_PC$statistic, 
                mantel_FW_WN_full_PC$statistic, mantel_FW_ST_l_full_PC$statistic, mantel_FW_ST_h_full_PC$statistic, 
                mantel_FW_ST_lh_full_PC$statistic),
  Significance = c(mantel_FW_OS_full_PC$signif, mantel_FW_ST_full_PC$signif, 
                   mantel_FW_WN_full_PC$signif, mantel_FW_ST_l_full_PC$signif, mantel_FW_ST_h_full_PC$signif, 
                   mantel_FW_ST_lh_full_PC$signif)
)

# Combine summary results into a dataframe
summary_results <- data.frame(
  Group = c("FW_OS_full_PC", "FW_WN_full_PC", "FW_ST_full_PC", 
            "FW_ST.l_full_PC", "FW_ST.h_full_PC", "FW_ST.lh_full_PC"),
  Mean = c(summary_FW_OS_full_PC$mean, summary_FW_WN_full_PC$mean, 
           summary_FW_ST_full_PC$mean, summary_FW_ST_l_full_PC$mean, summary_FW_ST_h_full_PC$mean, 
           summary_FW_ST_lh_full_PC$mean),
  SD = c(summary_FW_OS_full_PC$sd, summary_FW_WN_full_PC$sd, 
         summary_FW_ST_full_PC$sd, summary_FW_ST_l_full_PC$sd, summary_FW_ST_h_full_PC$sd, 
         summary_FW_ST_lh_full_PC$sd)
)

# Combine Mantel test results and summary statistics into one table
combined_results_FULL_PAR_CAT <- merge(mantel_results, summary_results, by = "Group")

# Add a column indicating the dataset type
combined_results_FULL_PAR_CAT$Dataset <- "Complete dataset"



```

